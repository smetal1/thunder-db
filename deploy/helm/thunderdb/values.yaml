# Default values for ThunderDB Helm chart

# Number of replicas (use 3 or 5 for production clustering)
replicaCount: 3

# Image configuration
image:
  repository: saurav7055/thunderdb
  tag: "0.6.0"
  pullPolicy: IfNotPresent

# Image pull secrets (if using private registry)
imagePullSecrets: []

# Override chart name
nameOverride: ""
fullnameOverride: ""

# Service account configuration
serviceAccount:
  create: false
  annotations: {}
  name: ""

# Pod annotations
podAnnotations: {}

# Pod security context
podSecurityContext:
  fsGroup: 1000
  runAsUser: 1000
  runAsGroup: 1000

# Container security context
securityContext: {}

# Service configuration
service:
  type: ClusterIP
  ports:
    postgres: 5432
    mysql: 3306
    resp: 6379
    http: 8080
    grpc: 9090

# Resource requests and limits
resources:
  requests:
    cpu: 1
    memory: 1Gi
  limits:
    cpu: 4
    memory: 8Gi

# Node selector
nodeSelector: {}

# Tolerations
tolerations: []

# Affinity rules
affinity: {}

# Persistence configuration
persistence:
  data:
    enabled: true
    size: 50Gi
    storageClass: ""
    accessMode: ReadWriteOnce
  wal:
    enabled: true
    size: 20Gi
    storageClass: ""
    accessMode: ReadWriteOnce

# Health check probes
probes:
  startup:
    enabled: true
    path: /api/v1/health
    port: http
    initialDelaySeconds: 5
    periodSeconds: 5
    failureThreshold: 30
  liveness:
    enabled: true
    path: /api/v1/health
    port: http
    initialDelaySeconds: 10
    periodSeconds: 10
    failureThreshold: 3
  readiness:
    enabled: true
    path: /api/v1/health
    port: http
    initialDelaySeconds: 5
    periodSeconds: 5
    failureThreshold: 3

# Pod disruption budget
podDisruptionBudget:
  enabled: true
  minAvailable: 1

# Termination grace period
terminationGracePeriodSeconds: 30

# ThunderDB configuration
config:
  # Core settings
  nodeId: 1
  queryTimeout: "30s"
  maxResultRows: 1000000

  # Storage settings
  storage:
    bufferPoolSize: "1GB"
    walBufferSize: "64MB"
    pageSize: "16KB"
    checkpointInterval: "5m"
    compactionThreads: 4
    directIo: true
    compression:
      enabled: true
      algorithm: "Lz4"
    maxWalSize: "2GB"
    diskSpaceWarningThreshold: 10
    diskSpaceCriticalThreshold: 5

  # Cluster settings
  cluster:
    name: "thunderdb-k8s"
    replicationFactor: 3
    autoBalance: true
    raftElectionTimeout: "1s"
    raftHeartbeatInterval: "100ms"
    maxRegionSize: "256MB"
    minRegionSize: "64MB"
    # Gossip-based auto-discovery settings
    gossipInterval: "1s"
    phiThreshold: 8.0
    # First node (ordinal 0) is seed node - auto-configured in statefulset

  # Security settings
  security:
    authenticationEnabled: true
    tlsEnabled: false
    superuser: "admin"

  # Logging settings
  logging:
    level: "info"
    format: "json"
    slowQueryLogging:
      enabled: true
      threshold: "1s"

# Credentials
credentials:
  # The superuser password hash (Argon2id)
  # Generate with: thunderdb --hash-password "your-secure-password"
  superuserPasswordHash: "$argon2id$v=19$m=65536,t=3,p=4$c29tZXNhbHQ$RdescudvJCsgt3ub+b+dWRWJTmaaJObG"
  # Use existing secret if already created
  existingSecret: "thunderdb-credentials"
  existingSecretKey: "THUNDERDB_SUPERUSER_PASSWORD_HASH"

# ------------------------------------------------
# Benchmark configuration (pgbench via K8s Job)
# Set benchmark.enabled=true to run pgbench after install/upgrade
# ------------------------------------------------
benchmark:
  enabled: false
  ttlSecondsAfterFinished: 3600
  backoffLimit: 2
  activeDeadlineSeconds: 7200

  # Scheduling constraints for the benchmark pod
  nodeSelector: {}
  tolerations: []
  affinity: {}

  # Log upload configuration (uploads benchmark logs after completion)
  logUpload:
    enabled: false
    # Pre-authenticated request URL (Oracle Object Storage, S3-compatible, etc.)
    # Must end with '/' â€” the object name will be appended
    url: ""
    # Image used for the upload sidecar container
    image: "curlimages/curl:latest"

  pgbench:
    # pgbench client image (postgres:16-alpine includes pgbench + psql, arm64 native)
    image:
      repository: postgres
      tag: "16-alpine"
      pullPolicy: IfNotPresent

    # Target database (created automatically by pgbench -i)
    database: "benchmark"

    # Secret key containing the plaintext password (not the hash)
    passwordSecretKey: "THUNDERDB_SUPERUSER_PASSWORD"

    # -s  Scale factor: row count = scale * 100,000
    scale: 100

    # -c  Number of concurrent client sessions
    clients: 10

    # -j  Number of worker threads inside pgbench
    threads: 2

    # -T  Duration of each benchmark phase in seconds
    duration: 60

    # -P  Progress report interval in seconds
    progressInterval: 5

    # --foreign-keys during init
    foreignKeys: true

    # -b  Built-in scripts to run (select-only, tpcb-like, simple-update)
    builtinScripts:
      - select-only
      - tpcb-like
      - simple-update

    # Scaling test: run tpcb-like with increasing client counts
    scalingTest:
      enabled: true
      clientCounts:
        - "1"
        - "5"
        - "10"
        - "20"
        - "50"
      duration: 30

    # -f  Custom SQL script (optional). Set to a multi-line SQL string.
    # Example:
    #   customScript: |
    #     \set aid random(1, 100000 * :scale)
    #     SELECT abalance FROM pgbench_accounts WHERE aid = :aid;
    customScript: ""

    # Resources for the init container
    initResources:
      requests:
        cpu: 500m
        memory: 256Mi
      limits:
        cpu: 2
        memory: 1Gi

    # Resources for the benchmark runner container
    resources:
      requests:
        cpu: 1
        memory: 512Mi
      limits:
        cpu: 4
        memory: 2Gi
