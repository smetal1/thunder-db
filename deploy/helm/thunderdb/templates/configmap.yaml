apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "thunderdb.configmapName" . }}
  labels:
    {{- include "thunderdb.labels" . | nindent 4 }}
data:
  thunderdb.toml: |
    # ThunderDB Configuration
    # Generated by Helm chart
    # Note: node_id is overridden via THUNDERDB_NODE_ID environment variable

    # Server settings (node_id will be overridden by env var)
    node_id = 1
    listen_addr = "0.0.0.0"
    pg_port = {{ .Values.service.ports.postgres }}
    mysql_port = {{ .Values.service.ports.mysql }}
    resp_port = {{ .Values.service.ports.resp }}
    http_port = {{ .Values.service.ports.http }}
    grpc_port = {{ .Values.service.ports.grpc }}
    data_dir = "/var/lib/thunderdb/data"
    wal_dir = "/var/lib/thunderdb/wal"
    query_timeout = {{ .Values.config.queryTimeout | quote }}
    max_result_rows = {{ .Values.config.maxResultRows | int }}

    [storage]
    # Values in bytes (1GB = 1073741824, 64MB = 67108864, 16KB = 16384)
    buffer_pool_size = 1073741824
    wal_buffer_size = 67108864
    page_size = 16384
    checkpoint_interval = {{ .Values.config.storage.checkpointInterval | quote }}
    compaction_threads = {{ .Values.config.storage.compactionThreads }}
    direct_io = {{ .Values.config.storage.directIo }}
    compression = {{ .Values.config.storage.compression.enabled }}
    compression_algorithm = "Lz4"
    max_wal_size = 2147483648
    sync_commit = true
    disk_space_warn_percent = {{ .Values.config.storage.diskSpaceWarningThreshold | default 10.0 }}
    disk_space_critical_percent = {{ .Values.config.storage.diskSpaceCriticalThreshold | default 5.0 }}

    [cluster]
    cluster_name = {{ .Values.config.cluster.name | quote }}
    replication_factor = {{ .Values.config.cluster.replicationFactor }}
    auto_balance = {{ .Values.config.cluster.autoBalance }}
    raft_election_timeout = {{ .Values.config.cluster.raftElectionTimeout | quote }}
    raft_heartbeat_interval = {{ .Values.config.cluster.raftHeartbeatInterval | quote }}
    # Values in bytes (256MB = 268435456, 64MB = 67108864)
    max_region_size = 268435456
    min_region_size = 67108864
    gossip_interval = {{ .Values.config.cluster.gossipInterval | default "1s" | quote }}
    phi_threshold = {{ .Values.config.cluster.phiThreshold | default 8.0 }}
    # seeds and is_seed are set via environment variables for dynamic discovery
    peers = []

    [security]
    authentication_enabled = {{ .Values.config.security.authenticationEnabled }}
    tls_enabled = {{ .Values.config.security.tlsEnabled }}
    superuser = {{ .Values.config.security.superuser | quote }}
    require_password_change = false
    min_password_length = 12
    max_login_attempts = 5
    lockout_duration_secs = 300
    pii_log_masking = true
    rate_limit_requests_per_second = 100.0
    rate_limit_burst = 200

    [logging]
    level = {{ .Values.config.logging.level | quote }}
    format = {{ .Values.config.logging.format | quote }}
    slow_query_enabled = {{ .Values.config.logging.slowQueryLogging.enabled }}
    slow_query_threshold = {{ .Values.config.logging.slowQueryLogging.threshold | quote }}
