apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "thunderdb.configmapName" . }}
  labels:
    {{- include "thunderdb.labels" . | nindent 4 }}
data:
  thunderdb.toml: |
    # ThunderDB Configuration
    # Generated by Helm chart

    [core]
    node_id = {{ .Values.config.nodeId }}

    [core.ports]
    postgres = {{ .Values.service.ports.postgres }}
    mysql = {{ .Values.service.ports.mysql }}
    resp = {{ .Values.service.ports.resp }}
    http = {{ .Values.service.ports.http }}
    grpc = {{ .Values.service.ports.grpc }}

    [core.paths]
    data_dir = "/var/lib/thunderdb/data"
    wal_dir = "/var/lib/thunderdb/wal"

    [core.limits]
    query_timeout = {{ .Values.config.queryTimeout | quote }}
    max_result_rows = {{ .Values.config.maxResultRows }}

    [storage]
    buffer_pool_size = {{ .Values.config.storage.bufferPoolSize | quote }}
    wal_buffer_size = {{ .Values.config.storage.walBufferSize | quote }}
    page_size = {{ .Values.config.storage.pageSize | quote }}
    checkpoint_interval = {{ .Values.config.storage.checkpointInterval | quote }}
    compaction_threads = {{ .Values.config.storage.compactionThreads }}
    direct_io = {{ .Values.config.storage.directIo }}
    max_wal_size = {{ .Values.config.storage.maxWalSize | quote }}
    disk_space_warning_threshold = {{ .Values.config.storage.diskSpaceWarningThreshold }}
    disk_space_critical_threshold = {{ .Values.config.storage.diskSpaceCriticalThreshold }}

    [storage.compression]
    enabled = {{ .Values.config.storage.compression.enabled }}
    algorithm = {{ .Values.config.storage.compression.algorithm | quote }}

    [cluster]
    name = {{ .Values.config.cluster.name | quote }}
    replication_factor = {{ .Values.config.cluster.replicationFactor }}
    auto_balance = {{ .Values.config.cluster.autoBalance }}
    raft_election_timeout = {{ .Values.config.cluster.raftElectionTimeout | quote }}
    raft_heartbeat_interval = {{ .Values.config.cluster.raftHeartbeatInterval | quote }}
    max_region_size = {{ .Values.config.cluster.maxRegionSize | quote }}
    min_region_size = {{ .Values.config.cluster.minRegionSize | quote }}
    {{- if .Values.config.cluster.peers }}
    peers = [
      {{- range $i, $peer := .Values.config.cluster.peers }}
      {{- if $i }},{{ end }}
      {{ $peer | quote }}
      {{- end }}
    ]
    {{- end }}

    [security]
    authentication_enabled = {{ .Values.config.security.authenticationEnabled }}
    tls_enabled = {{ .Values.config.security.tlsEnabled }}
    superuser = {{ .Values.config.security.superuser | quote }}

    [logging]
    level = {{ .Values.config.logging.level | quote }}
    format = {{ .Values.config.logging.format | quote }}

    [logging.slow_query]
    enabled = {{ .Values.config.logging.slowQueryLogging.enabled }}
    threshold = {{ .Values.config.logging.slowQueryLogging.threshold | quote }}
