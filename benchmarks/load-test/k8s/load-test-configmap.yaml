apiVersion: v1
kind: ConfigMap
metadata:
  name: load-test-scripts
  namespace: thunderdb
data:
  config.sh: |
    #!/bin/bash
    # Load Test Configuration

    export THUNDERDB_HOST="${THUNDERDB_HOST:-thunderdb}"
    export THUNDERDB_PG_PORT="${THUNDERDB_PG_PORT:-5432}"
    export THUNDERDB_USER="${THUNDERDB_USER:-admin}"
    export THUNDERDB_PASSWORD="${THUNDERDB_PASSWORD:-thunder}"
    export THUNDERDB_DATABASE="${THUNDERDB_DATABASE:-default}"

    # Test parameters
    export CONCURRENCY_LEVELS="${CONCURRENCY_LEVELS:-1 2 4 8 16 32}"
    export DATASET_SIZES="${DATASET_SIZES:-1000 10000 50000}"
    export TEST_DURATION="${TEST_DURATION:-60}"
    export WARMUP_DURATION="${WARMUP_DURATION:-5}"
    export READ_PERCENTAGE="${READ_PERCENTAGE:-80}"
    export WRITE_PERCENTAGE="${WRITE_PERCENTAGE:-20}"
    export NUM_SAMPLES="${NUM_SAMPLES:-1000}"

    # Thresholds
    export P99_LATENCY_THRESHOLD_MS="${P99_LATENCY_THRESHOLD_MS:-100}"
    export ERROR_RATE_THRESHOLD="${ERROR_RATE_THRESHOLD:-0.01}"

    # Output directory
    export RUN_DIR="${RUN_DIR:-/tmp/load-test-results}"
    mkdir -p "$RUN_DIR/raw" "$RUN_DIR/metrics"

    # Logging functions
    log_info() { echo "[INFO] $(date '+%Y-%m-%d %H:%M:%S') $*"; }
    log_warn() { echo "[WARN] $(date '+%Y-%m-%d %H:%M:%S') $*"; }
    log_error() { echo "[ERROR] $(date '+%Y-%m-%d %H:%M:%S') $*"; }
    log_success() { echo "[SUCCESS] $(date '+%Y-%m-%d %H:%M:%S') $*"; }

    # Percentile calculation
    calculate_percentile() {
      local file=$1
      local pct=$2
      local count=$(wc -l < "$file")
      local idx=$(echo "scale=0; $count * $pct / 100" | bc)
      [ "$idx" -lt 1 ] && idx=1
      sed -n "${idx}p" "$file"
    }

    # Connection test
    test_connection() {
      PGPASSWORD="$THUNDERDB_PASSWORD" psql -h "$THUNDERDB_HOST" -p "$THUNDERDB_PG_PORT" -U "$THUNDERDB_USER" -d "$THUNDERDB_DATABASE" -c "SELECT 1" > /dev/null 2>&1
    }

  init-tables.sh: |
    #!/bin/bash
    set -euo pipefail
    source /scripts/config.sh

    log_info "Initializing test tables..."

    PGPASSWORD="$THUNDERDB_PASSWORD" psql -h "$THUNDERDB_HOST" -p "$THUNDERDB_PG_PORT" -U "$THUNDERDB_USER" -d "$THUNDERDB_DATABASE" << 'EOF'
    CREATE TABLE IF NOT EXISTS load_test_accounts (
      id INTEGER PRIMARY KEY,
      balance INTEGER DEFAULT 0,
      filler TEXT
    );

    CREATE TABLE IF NOT EXISTS load_test_history (
      id INTEGER PRIMARY KEY,
      account_id INTEGER,
      delta INTEGER,
      mtime INTEGER
    );
    EOF

    # Check if data exists
    count=$(PGPASSWORD="$THUNDERDB_PASSWORD" psql -h "$THUNDERDB_HOST" -p "$THUNDERDB_PG_PORT" -U "$THUNDERDB_USER" -d "$THUNDERDB_DATABASE" -t -c "SELECT COUNT(*) FROM load_test_accounts" 2>/dev/null | tr -d ' ')

    if [ "${count:-0}" -lt 1000 ]; then
      log_info "Inserting initial test data (10000 rows)..."
      for batch in $(seq 0 9); do
        values=""
        for i in $(seq 1 1000); do
          id=$((batch * 1000 + i))
          [ -n "$values" ] && values="$values,"
          values="${values}($id, 0, '$(printf 'x%.0s' {1..84})')"
        done
        PGPASSWORD="$THUNDERDB_PASSWORD" psql -h "$THUNDERDB_HOST" -p "$THUNDERDB_PG_PORT" -U "$THUNDERDB_USER" -d "$THUNDERDB_DATABASE" -c "INSERT INTO load_test_accounts (id, balance, filler) VALUES $values" > /dev/null 2>&1
        log_info "  Inserted batch $((batch + 1))/10"
      done
    fi

    log_success "Test tables ready"

  test-concurrency.sh: |
    #!/bin/bash
    set -euo pipefail
    source /scripts/config.sh

    OUTPUT_FILE="$RUN_DIR/raw/concurrency_results.csv"

    log_info "Starting concurrency scaling tests..."
    echo "concurrency,throughput_qps,avg_latency_ms,p50_latency_ms,p95_latency_ms,p99_latency_ms,errors,error_rate" > "$OUTPUT_FILE"

    run_worker() {
      local duration=$1
      local latency_file=$2
      local end_time=$(($(date +%s) + duration))
      local queries=0 errors=0

      while [ $(date +%s) -lt $end_time ]; do
        local start_ms=$(date +%s%3N)
        local account_id=$((RANDOM % 10000 + 1))

        if [ $((RANDOM % 100)) -lt $READ_PERCENTAGE ]; then
          if PGPASSWORD="$THUNDERDB_PASSWORD" psql -h "$THUNDERDB_HOST" -p "$THUNDERDB_PG_PORT" -U "$THUNDERDB_USER" -d "$THUNDERDB_DATABASE" -t -c "SELECT balance FROM load_test_accounts WHERE id = $account_id" > /dev/null 2>&1; then
            queries=$((queries + 1))
            local end_ms=$(date +%s%3N)
            echo "$((end_ms - start_ms))" >> "$latency_file"
          else
            errors=$((errors + 1))
          fi
        else
          local delta=$((RANDOM % 1000 - 500))
          if PGPASSWORD="$THUNDERDB_PASSWORD" psql -h "$THUNDERDB_HOST" -p "$THUNDERDB_PG_PORT" -U "$THUNDERDB_USER" -d "$THUNDERDB_DATABASE" -c "UPDATE load_test_accounts SET balance = balance + $delta WHERE id = $account_id" > /dev/null 2>&1; then
            queries=$((queries + 1))
            local end_ms=$(date +%s%3N)
            echo "$((end_ms - start_ms))" >> "$latency_file"
          else
            errors=$((errors + 1))
          fi
        fi
      done
      echo "$queries,$errors"
    }

    for concurrency in $CONCURRENCY_LEVELS; do
      log_info "Testing with $concurrency concurrent clients..."

      LATENCY_FILE=$(mktemp)
      > "$LATENCY_FILE"

      # Warmup
      log_info "  Warming up..."
      for i in $(seq 1 $concurrency); do
        run_worker $WARMUP_DURATION /dev/null &
      done
      wait

      # Main test
      log_info "  Running test for ${TEST_DURATION}s..."
      start_time=$(date +%s)

      declare -a outputs
      for i in $(seq 1 $concurrency); do
        output=$(mktemp)
        outputs+=("$output")
        run_worker $TEST_DURATION "$LATENCY_FILE" > "$output" &
      done
      wait

      end_time=$(date +%s)
      duration=$((end_time - start_time))

      # Aggregate
      total_queries=0 total_errors=0
      for output in "${outputs[@]}"; do
        IFS=',' read -r q e < "$output"
        total_queries=$((total_queries + q))
        total_errors=$((total_errors + e))
        rm -f "$output"
      done

      throughput=$(echo "scale=2; $total_queries / $duration" | bc)
      error_rate=$(echo "scale=4; $total_errors / ($total_queries + $total_errors + 1)" | bc)

      if [ -s "$LATENCY_FILE" ]; then
        sort -n "$LATENCY_FILE" > "${LATENCY_FILE}.sorted"
        avg=$(awk '{sum+=$1} END {printf "%.2f", sum/NR}' "${LATENCY_FILE}.sorted")
        p50=$(calculate_percentile "${LATENCY_FILE}.sorted" 50)
        p95=$(calculate_percentile "${LATENCY_FILE}.sorted" 95)
        p99=$(calculate_percentile "${LATENCY_FILE}.sorted" 99)
        rm -f "${LATENCY_FILE}.sorted"
      else
        avg=0 p50=0 p95=0 p99=0
      fi
      rm -f "$LATENCY_FILE"

      echo "$concurrency,$throughput,$avg,$p50,$p95,$p99,$total_errors,$error_rate" >> "$OUTPUT_FILE"
      log_info "  Results: ${throughput} QPS, p50=${p50}ms, p95=${p95}ms, p99=${p99}ms, errors=${total_errors}"

      unset outputs
    done

    log_success "Concurrency tests completed"
    echo ""
    echo "=== Concurrency Test Results ==="
    column -t -s',' "$OUTPUT_FILE"

  test-latency.sh: |
    #!/bin/bash
    set -euo pipefail
    source /scripts/config.sh

    OUTPUT_FILE="$RUN_DIR/raw/latency_results.csv"

    log_info "Starting latency analysis..."
    echo "query_type,samples,min_ms,max_ms,avg_ms,p50_ms,p95_ms,p99_ms" > "$OUTPUT_FILE"

    run_latency_test() {
      local name=$1
      local query_template=$2
      local samples=$NUM_SAMPLES
      local latency_file=$(mktemp)

      log_info "  Testing $name ($samples samples)..."

      for i in $(seq 1 $samples); do
        local id=$((RANDOM % 10000 + 1))
        local query="${query_template//\$ID/$id}"

        local start_ms=$(date +%s%3N)
        PGPASSWORD="$THUNDERDB_PASSWORD" psql -h "$THUNDERDB_HOST" -p "$THUNDERDB_PG_PORT" -U "$THUNDERDB_USER" -d "$THUNDERDB_DATABASE" -c "$query" > /dev/null 2>&1
        local end_ms=$(date +%s%3N)
        echo "$((end_ms - start_ms))" >> "$latency_file"
      done

      sort -n "$latency_file" > "${latency_file}.sorted"
      local count=$(wc -l < "${latency_file}.sorted")
      local min=$(head -1 "${latency_file}.sorted")
      local max=$(tail -1 "${latency_file}.sorted")
      local avg=$(awk '{sum+=$1} END {printf "%.2f", sum/NR}' "${latency_file}.sorted")
      local p50=$(calculate_percentile "${latency_file}.sorted" 50)
      local p95=$(calculate_percentile "${latency_file}.sorted" 95)
      local p99=$(calculate_percentile "${latency_file}.sorted" 99)

      echo "$name,$count,$min,$max,$avg,$p50,$p95,$p99" >> "$OUTPUT_FILE"
      log_info "    avg=${avg}ms, p50=${p50}ms, p95=${p95}ms, p99=${p99}ms"

      rm -f "$latency_file" "${latency_file}.sorted"
    }

    run_latency_test "point_select" "SELECT balance FROM load_test_accounts WHERE id = \$ID"
    run_latency_test "update" "UPDATE load_test_accounts SET balance = balance + 1 WHERE id = \$ID"
    run_latency_test "aggregate" "SELECT COUNT(*), SUM(balance) FROM load_test_accounts WHERE id <= 1000"

    log_success "Latency analysis completed"
    echo ""
    echo "=== Latency Results ==="
    column -t -s',' "$OUTPUT_FILE"

  run-all.sh: |
    #!/bin/bash
    set -euo pipefail
    source /scripts/config.sh

    echo "╔════════════════════════════════════════════════════════════════╗"
    echo "║           ThunderDB Load Test Suite (Kubernetes)               ║"
    echo "╠════════════════════════════════════════════════════════════════╣"
    echo "║  Host: $THUNDERDB_HOST:$THUNDERDB_PG_PORT                      "
    echo "║  Duration: ${TEST_DURATION}s per test                          "
    echo "║  Concurrency levels: $CONCURRENCY_LEVELS                       "
    echo "╚════════════════════════════════════════════════════════════════╝"
    echo ""

    log_info "Testing connection to ThunderDB..."
    retry=0
    while ! test_connection; do
      retry=$((retry + 1))
      if [ $retry -gt 30 ]; then
        log_error "Failed to connect to ThunderDB after 30 attempts"
        exit 1
      fi
      log_warn "Connection failed, retrying in 2s... ($retry/30)"
      sleep 2
    done
    log_success "Connected to ThunderDB"

    log_info "Initializing test tables..."
    /scripts/init-tables.sh

    log_info "Running concurrency tests..."
    /scripts/test-concurrency.sh

    log_info "Running latency tests..."
    /scripts/test-latency.sh

    echo ""
    echo "╔════════════════════════════════════════════════════════════════╗"
    echo "║                    Load Test Complete                          ║"
    echo "╚════════════════════════════════════════════════════════════════╝"
    echo ""
    echo "Results saved to: $RUN_DIR"
    ls -la "$RUN_DIR/raw/"
